name: Sync dev with main

on:
  workflow_dispatch:
  # Optionally auto-sync after releases (uncomment if desired)
  # push:
  #   branches:
  #     - main
  #   tags:
  #     - 'v*'

permissions:
  contents: write
  pull-requests: write

jobs:
  sync-branches:
    name: Sync dev branch with main
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main
      
      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Fetch branches
        run: |
          git fetch origin main
          git fetch origin dev
      
      - name: Check if sync needed
        id: check_sync
        run: |
          # Check if dev is behind main
          COMMITS_BEHIND=$(git rev-list --count dev..origin/main)
          
          if [ "$COMMITS_BEHIND" -eq 0 ]; then
            echo "sync_needed=false" >> $GITHUB_OUTPUT
            echo "Dev is already up-to-date with main"
          else
            echo "sync_needed=true" >> $GITHUB_OUTPUT
            echo "commits_behind=$COMMITS_BEHIND" >> $GITHUB_OUTPUT
            echo "Dev is $COMMITS_BEHIND commits behind main"
          fi
      
      - name: Attempt fast-forward merge
        if: steps.check_sync.outputs.sync_needed == 'true'
        id: fast_forward
        run: |
          git checkout dev
          
          # Try fast-forward merge
          if git merge --ff-only origin/main; then
            echo "merge_type=fast-forward" >> $GITHUB_OUTPUT
            echo "success=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Fast-forward merge successful"
          else
            echo "merge_type=requires-pr" >> $GITHUB_OUTPUT
            echo "success=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Cannot fast-forward - conflicts may exist"
          fi
      
      - name: Push fast-forward merge
        if: steps.check_sync.outputs.sync_needed == 'true' && steps.fast_forward.outputs.success == 'true'
        run: |
          git push origin dev
          echo "‚úÖ Dev branch updated with main via fast-forward"
      
      - name: Create sync PR for conflicts
        if: steps.check_sync.outputs.sync_needed == 'true' && steps.fast_forward.outputs.success == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Create a branch for the sync
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          BRANCH_NAME="sync/main-to-dev-${TIMESTAMP}"
          
          git checkout -b "${BRANCH_NAME}" origin/dev
          
          # Attempt merge (will fail if conflicts)
          if git merge origin/main --no-commit --no-ff; then
            # No conflicts - create merge commit
            git commit -m "chore: Sync dev with main

Automatic sync of main branch changes to dev.

This merge was created by the sync workflow after a release or hotfix."
            
            git push origin "${BRANCH_NAME}"
            
            # Create PR
            gh pr create \
              --title "chore: Sync dev with main" \
              --body "## üîÑ Branch Sync: main ‚Üí dev

This PR synchronizes the dev branch with recent changes in main.

### Changes
- Merges ${{ steps.check_sync.outputs.commits_behind }} commit(s) from main into dev

### Reason for Sync
This sync ensures that any hotfixes or changes made directly to main are also present in the dev branch.

### Review Notes
- Review the changes to ensure no conflicts
- Verify that dev remains functional after merge
- This is a standard maintenance PR

---

*Auto-generated by [Sync workflow](.github/workflows/sync-branches.yml)*" \
              --base dev \
              --head "${BRANCH_NAME}" \
              --label "maintenance" \
              --label "sync"
            
            echo "‚úÖ Sync PR created: ${BRANCH_NAME} ‚Üí dev"
          else
            # Conflicts detected - abort and create PR with instructions
            git merge --abort
            
            cat > /tmp/conflict-instructions.md << 'EOF'
## ‚ö†Ô∏è Manual Sync Required: main ‚Üí dev

Automatic synchronization failed due to merge conflicts.

### What Happened
The automatic merge of `main` into `dev` encountered conflicts that require manual resolution.

### Commits to Sync
- **Commits behind**: $COMMITS_BEHIND

### Resolution Steps

1. **Checkout dev branch**:
   ```bash
   git checkout dev
   git pull origin dev
   ```

2. **Merge main and resolve conflicts**:
   ```bash
   git merge origin/main
   # Git will report conflicts
   ```

3. **Resolve each conflict**:
   - Open conflicted files in your editor
   - Look for conflict markers: `<<<<<<<`, `=======`, `>>>>>>>`
   - Choose the correct code for each conflict
   - Remove conflict markers

4. **Test the merged code**:
   ```bash
   # Run tests
   composer test
   ```

5. **Complete the merge**:
   ```bash
   git add .
   git commit -m "chore: Sync dev with main (manual conflict resolution)"
   git push origin dev
   ```

### Need Help?
- Review the [Git conflict resolution guide](https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/addressing-merge-conflicts/resolving-a-merge-conflict-using-the-command-line)
- Ask a maintainer for assistance
- Consider reviewing what changed in main vs dev to understand conflicts

---

*This issue was created by the [Sync workflow](.github/workflows/sync-branches.yml)*
EOF
            
            sed -i "s/\$COMMITS_BEHIND/${{ steps.check_sync.outputs.commits_behind }}/g" /tmp/conflict-instructions.md
            
            # Create an issue to track manual resolution
            gh issue create \
              --title "Manual sync required: main ‚Üí dev (conflicts detected)" \
              --body-file /tmp/conflict-instructions.md \
              --label "maintenance" \
              --label "help-wanted" \
              --label "sync"
            
            echo "‚ö†Ô∏è Conflicts detected - created issue for manual resolution"
          fi
      
      - name: Summary
        if: always()
        run: |
          if [ "${{ steps.check_sync.outputs.sync_needed }}" == "false" ]; then
            echo "::notice::Dev branch is already up-to-date with main"
          elif [ "${{ steps.fast_forward.outputs.success }}" == "true" ]; then
            echo "::notice::Dev branch successfully synced with main via fast-forward"
          elif [ "${{ steps.fast_forward.outputs.merge_type }}" == "requires-pr" ]; then
            echo "::warning::Sync requires PR or manual resolution - check PRs or issues"
          fi
