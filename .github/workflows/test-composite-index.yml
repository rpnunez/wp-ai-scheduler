name: Test Composite Index

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  test-composite-index:
    name: Test Composite Index in aips_schedule
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        ports: [3306:3306]
        env:
          MYSQL_ROOT_PASSWORD: ""
          MYSQL_ALLOW_EMPTY_PASSWORD: "yes"
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, intl, xml, curl, zip, dom, fileinfo, mysqli
          tools: composer:v2

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y subversion mysql-client

      - name: Wait for MySQL and Prepare Database
        run: |
          ATTEMPTS=10
          until mysqladmin ping -h127.0.0.1 --silent; do
            ATTEMPTS=$((ATTEMPTS-1))
            if [ $ATTEMPTS -le 0 ]; then
              echo "MySQL did not become ready in time."
              exit 1
            fi
            echo "Waiting for MySQL to be ready..."
            sleep 5
          done
          
          # Create the database
          mysql -h127.0.0.1 -uroot -e "CREATE DATABASE IF NOT EXISTS wordpress_test;"
          echo "Database created successfully."

      - name: Install Composer Dependencies
        run: cd ai-post-scheduler && composer install --no-interaction --prefer-dist --no-progress

      - name: Install WordPress Test Library
        run: |
          cd ai-post-scheduler
          bash ../tools/install-wp-tests.sh wordpress_test root '' 127.0.0.1 latest true
        env:
          WP_TESTS_DIR: /tmp/wordpress-tests-lib
          WP_CORE_DIR: /tmp/wordpress

      - name: Run Database Schema Tests
        run: cd ai-post-scheduler && vendor/bin/phpunit tests/test-db-schema.php --testdox
        env:
          WP_TESTS_DIR: /tmp/wordpress-tests-lib
          WP_CORE_DIR: /tmp/wordpress

      - name: Verify Composite Index Directly in Database
        run: |
          echo "Verifying composite index 'is_active_next_run' exists in database..."
          
          # Query the database for the index
          mysql -h127.0.0.1 -uroot wordpress_test -e "
            SHOW INDEX FROM wp_aips_schedule WHERE Key_name = 'is_active_next_run';
          "
          
          echo ""
          echo "Composite index verification complete!"

      - name: Display Index Details
        run: |
          echo "All indexes on wp_aips_schedule table:"
          mysql -h127.0.0.1 -uroot wordpress_test -e "
            SHOW INDEX FROM wp_aips_schedule;
          "

      - name: Test Summary
        if: always()
        run: |
          echo "============================================"
          echo "Test Summary: Composite Index Verification"
          echo "============================================"
          echo ""
          echo "✓ Schema changes implemented:"
          echo "  - Added composite index: is_active_next_run"
          echo "  - Index columns: (is_active, next_run)"
          echo "  - Table: wp_aips_schedule"
          echo ""
          echo "✓ Verification methods:"
          echo "  - PHPUnit test suite"
          echo "  - Direct database query"
          echo ""
