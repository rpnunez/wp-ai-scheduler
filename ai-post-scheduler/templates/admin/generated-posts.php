<?php
/**
 * Generated Posts Admin Template
 *
 * Displays all posts generated by the AI Post Scheduler plugin.
 *
 * @package AI_Post_Scheduler
 * @since 2.0.0
 */

if (!defined('ABSPATH')) {
	exit;
}
?>

<div class="wrap">
	<h1><?php esc_html_e('Generated Posts', 'ai-post-scheduler'); ?></h1>
	
	<p><?php esc_html_e('View all posts that have been generated by the AI Post Scheduler plugin.', 'ai-post-scheduler'); ?></p>
	
	<!-- Search Form -->
	<form method="get" class="search-form">
		<input type="hidden" name="page" value="aips-generated-posts">
		<p class="search-box">
			<label class="screen-reader-text" for="post-search-input"><?php esc_html_e('Search Posts:', 'ai-post-scheduler'); ?></label>
			<input type="search" id="post-search-input" name="s" value="<?php echo esc_attr($search_query); ?>" placeholder="<?php esc_attr_e('Search posts...', 'ai-post-scheduler'); ?>">
			<input type="submit" id="search-submit" class="button" value="<?php esc_attr_e('Search Posts', 'ai-post-scheduler'); ?>">
		</p>
	</form>
	
	<table class="wp-list-table widefat fixed striped">
		<thead>
			<tr>
				<th scope="col"><?php esc_html_e('Title', 'ai-post-scheduler'); ?></th>
				<th scope="col"><?php esc_html_e('Date Scheduled', 'ai-post-scheduler'); ?></th>
				<th scope="col"><?php esc_html_e('Date Published', 'ai-post-scheduler'); ?></th>
				<th scope="col"><?php esc_html_e('Date Generated', 'ai-post-scheduler'); ?></th>
				<th scope="col"><?php esc_html_e('Actions', 'ai-post-scheduler'); ?></th>
			</tr>
		</thead>
		<tbody>
			<?php if (!empty($posts_data)): ?>
				<?php foreach ($posts_data as $post_data): ?>
				<tr>
					<td>
						<strong>
							<a href="<?php echo esc_url($post_data['edit_link']); ?>">
								<?php echo esc_html($post_data['title']); ?>
							</a>
						</strong>
					</td>
					<td>
						<?php 
						if ($post_data['date_scheduled']) {
							echo esc_html(date_i18n(get_option('date_format') . ' ' . get_option('time_format'), strtotime($post_data['date_scheduled'])));
						} else {
							echo 'â€”';
						}
						?>
					</td>
					<td>
						<?php echo esc_html(date_i18n(get_option('date_format') . ' ' . get_option('time_format'), strtotime($post_data['date_published']))); ?>
					</td>
					<td>
						<?php echo esc_html(date_i18n(get_option('date_format') . ' ' . get_option('time_format'), strtotime($post_data['date_generated']))); ?>
					</td>
					<td>
						<a href="<?php echo esc_url($post_data['edit_link']); ?>" class="button button-small">
							<?php esc_html_e('Edit', 'ai-post-scheduler'); ?>
						</a>
						<button class="button button-small aips-view-session" data-history-id="<?php echo esc_attr($post_data['history_id']); ?>">
							<?php esc_html_e('View Session', 'ai-post-scheduler'); ?>
						</button>
					</td>
				</tr>
				<?php endforeach; ?>
			<?php else: ?>
				<tr>
					<td colspan="5" class="no-items">
						<?php esc_html_e('No generated posts found.', 'ai-post-scheduler'); ?>
					</td>
				</tr>
			<?php endif; ?>
		</tbody>
		<tfoot>
			<tr>
				<th scope="col"><?php esc_html_e('Title', 'ai-post-scheduler'); ?></th>
				<th scope="col"><?php esc_html_e('Date Scheduled', 'ai-post-scheduler'); ?></th>
				<th scope="col"><?php esc_html_e('Date Published', 'ai-post-scheduler'); ?></th>
				<th scope="col"><?php esc_html_e('Date Generated', 'ai-post-scheduler'); ?></th>
				<th scope="col"><?php esc_html_e('Actions', 'ai-post-scheduler'); ?></th>
			</tr>
		</tfoot>
	</table>
	
	<!-- Pagination -->
	<?php if ($history['pages'] > 1): ?>
		<div class="tablenav">
			<div class="tablenav-pages">
				<?php
				$page_links = paginate_links(array(
					'base' => add_query_arg('paged', '%#%'),
					'format' => '',
					'prev_text' => '&laquo;',
					'next_text' => '&raquo;',
					'total' => $history['pages'],
					'current' => $current_page,
				));
				if ($page_links) {
					echo '<span class="displaying-num">' . sprintf(
						/* translators: %s: total number of items */
						_n('%s item', '%s items', $history['total'], 'ai-post-scheduler'),
						number_format_i18n($history['total'])
					) . '</span>';
					echo wp_kses_post( $page_links );
				}
				?>
			</div>
		</div>
	<?php endif; ?>
</div>

<!-- Session View Modal -->
<div id="aips-session-modal" class="aips-modal" style="display: none;">
	<div class="aips-modal-overlay"></div>
	<div class="aips-modal-content">
		<div class="aips-modal-header">
			<h2><?php esc_html_e('View Session', 'ai-post-scheduler'); ?></h2>
			<button class="aips-modal-close" aria-label="<?php esc_attr_e('Close', 'ai-post-scheduler'); ?>">
				<span class="dashicons dashicons-no"></span>
			</button>
		</div>
		<div class="aips-modal-body">
			<div class="aips-session-info">
				<p><strong><?php esc_html_e('Post:', 'ai-post-scheduler'); ?></strong> <span id="aips-session-title"></span></p>
				<p><strong><?php esc_html_e('Generated:', 'ai-post-scheduler'); ?></strong> <span id="aips-session-created"></span></p>
				<p><strong><?php esc_html_e('Completed:', 'ai-post-scheduler'); ?></strong> <span id="aips-session-completed"></span></p>
			</div>
			
			<div class="aips-tabs">
				<ul class="aips-tab-nav">
					<li><a href="#aips-tab-logs" class="active"><?php esc_html_e('Logs', 'ai-post-scheduler'); ?></a></li>
					<li><a href="#aips-tab-ai"><?php esc_html_e('AI', 'ai-post-scheduler'); ?></a></li>
				</ul>
				
				<div id="aips-tab-logs" class="aips-tab-content active">
					<div id="aips-logs-list"></div>
				</div>
				
				<div id="aips-tab-ai" class="aips-tab-content" style="display: none;">
					<div id="aips-ai-list"></div>
				</div>
			</div>
		</div>
	</div>
</div>

<style>
.aips-modal {
	position: fixed;
	top: 0;
	left: 0;
	width: 100%;
	height: 100%;
	z-index: 100000;
}

.aips-modal-overlay {
	position: absolute;
	top: 0;
	left: 0;
	width: 100%;
	height: 100%;
	background: rgba(0, 0, 0, 0.7);
}

.aips-modal-content {
	position: relative;
	max-width: 900px;
	max-height: 90vh;
	margin: 5vh auto;
	background: #fff;
	border-radius: 4px;
	box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
	overflow: hidden;
	display: flex;
	flex-direction: column;
}

.aips-modal-header {
	display: flex;
	justify-content: space-between;
	align-items: center;
	padding: 20px;
	border-bottom: 1px solid #ddd;
}

.aips-modal-header h2 {
	margin: 0;
}

.aips-modal-close {
	background: none;
	border: none;
	cursor: pointer;
	padding: 0;
	font-size: 24px;
	line-height: 1;
}

.aips-modal-body {
	padding: 20px;
	overflow-y: auto;
	flex: 1;
}

.aips-session-info {
	margin-bottom: 20px;
	padding: 15px;
	background: #f9f9f9;
	border-radius: 4px;
}

.aips-session-info p {
	margin: 5px 0;
}

.aips-tabs {
	margin-top: 20px;
}

.aips-tab-nav {
	display: flex;
	gap: 10px;
	margin: 0;
	padding: 0;
	list-style: none;
	border-bottom: 1px solid #ddd;
}

.aips-tab-nav li {
	margin: 0;
}

.aips-tab-nav a {
	display: block;
	padding: 10px 20px;
	text-decoration: none;
	color: #555;
	border-bottom: 2px solid transparent;
}

.aips-tab-nav a.active {
	color: #0073aa;
	border-bottom-color: #0073aa;
}

.aips-tab-content {
	padding: 20px 0;
}

.aips-log-entry,
.aips-ai-component {
	padding: 15px;
	margin-bottom: 15px;
	background: #f9f9f9;
	border-left: 4px solid #ddd;
	border-radius: 4px;
}

.aips-log-entry.error {
	border-left-color: #dc3232;
}

.aips-log-entry.warning {
	border-left-color: #ffb900;
}

.aips-log-entry h4,
.aips-ai-component h4 {
	margin: 0 0 10px;
	font-size: 14px;
}

.aips-log-timestamp {
	font-size: 12px;
	color: #666;
	margin-bottom: 5px;
}

.aips-ai-component {
	cursor: pointer;
	transition: background 0.2s;
}

.aips-ai-component:hover {
	background: #f0f0f0;
}

.aips-ai-component.expanded {
	cursor: default;
}

.aips-ai-details {
	margin-top: 15px;
	display: none;
}

.aips-ai-component.expanded .aips-ai-details {
	display: block;
}

.aips-json-viewer {
	background: #282c34;
	color: #abb2bf;
	padding: 15px;
	border-radius: 4px;
	overflow-x: auto;
	font-family: 'Courier New', monospace;
	font-size: 13px;
	line-height: 1.6;
	max-height: 400px;
	overflow-y: auto;
}

.aips-json-viewer pre {
	margin: 0;
	white-space: pre-wrap;
	word-wrap: break-word;
}

.aips-ai-section {
	margin-bottom: 20px;
}

.aips-ai-section h5 {
	margin: 0 0 10px;
	font-size: 13px;
	color: #555;
	text-transform: uppercase;
	letter-spacing: 0.5px;
}
</style>

<script>
jQuery(document).ready(function($) {
	// History type constants (mirror PHP AIPS_History_Type)
	var AIPS_History_Type = {
		LOG: <?php echo AIPS_History_Type::LOG; ?>,
		ERROR: <?php echo AIPS_History_Type::ERROR; ?>,
		WARNING: <?php echo AIPS_History_Type::WARNING; ?>,
		INFO: <?php echo AIPS_History_Type::INFO; ?>,
		AI_REQUEST: <?php echo AIPS_History_Type::AI_REQUEST; ?>,
		AI_RESPONSE: <?php echo AIPS_History_Type::AI_RESPONSE; ?>,
		DEBUG: <?php echo AIPS_History_Type::DEBUG; ?>,
		ACTIVITY: <?php echo AIPS_History_Type::ACTIVITY; ?>,
		SESSION_METADATA: <?php echo AIPS_History_Type::SESSION_METADATA; ?>
	};
	
	var aipsAjaxNonce = '<?php echo wp_create_nonce('aips_ajax_nonce'); ?>';
	
	// View Session button handler
	$(document).on('click', '.aips-view-session', function() {
		var historyId = $(this).data('history-id');
		
		$.ajax({
			url: ajaxurl,
			type: 'POST',
			data: {
				action: 'aips_get_post_session',
				nonce: aipsAjaxNonce,
				history_id: historyId
			},
			success: function(response) {
				if (response.success) {
					displaySessionModal(response.data);
				} else {
					alert(response.data.message || '<?php esc_html_e('Failed to load session data.', 'ai-post-scheduler'); ?>');
				}
			},
			error: function() {
				alert('<?php esc_html_e('Failed to load session data.', 'ai-post-scheduler'); ?>');
			}
		});
	});
	
	// Close modal handlers
	$(document).on('click', '.aips-modal-close, .aips-modal-overlay', function() {
		$('#aips-session-modal').hide();
	});
	
	// Tab navigation
	$(document).on('click', '.aips-tab-nav a', function(e) {
		e.preventDefault();
		var target = $(this).attr('href');
		
		$('.aips-tab-nav a').removeClass('active');
		$(this).addClass('active');
		
		$('.aips-tab-content').hide();
		$(target).show();
	});
	
	// Toggle AI component details
	$(document).on('click', '.aips-ai-component:not(.expanded)', function() {
		$(this).addClass('expanded');
	});
	
	function displaySessionModal(data) {
		// Update session info
		$('#aips-session-title').text(data.history.generated_title);
		$('#aips-session-created').text(data.history.created_at);
		$('#aips-session-completed').text(data.history.completed_at || 'N/A');
		
		// Display logs
		var logsHtml = '';
		if (data.logs.length > 0) {
			data.logs.forEach(function(log) {
				var cssClass = log.type_id === AIPS_History_Type.ERROR ? 'error' : (log.type_id === AIPS_History_Type.WARNING ? 'warning' : '');
				logsHtml += '<div class="aips-log-entry ' + escapeHtml(cssClass) + '">';
				logsHtml += '<h4>' + escapeHtml(log.type) + ' - ' + escapeHtml(log.log_type) + '</h4>';
				logsHtml += '<div class="aips-log-timestamp">' + escapeHtml(log.timestamp) + '</div>';
				logsHtml += '<div class="aips-json-viewer"><pre>' + escapeHtml(JSON.stringify(log.details, null, 2)) + '</pre></div>';
				logsHtml += '</div>';
			});
		} else {
			logsHtml = '<p><?php esc_html_e('No log entries found.', 'ai-post-scheduler'); ?></p>';
		}
		$('#aips-logs-list').html(logsHtml);
		
		// Display AI calls
		var aiHtml = '';
		if (data.ai_calls.length > 0) {
			data.ai_calls.forEach(function(call) {
				aiHtml += '<div class="aips-ai-component">';
				aiHtml += '<h4>' + escapeHtml(call.label) + '</h4>';
				aiHtml += '<p><?php esc_html_e('Click to view request and response details', 'ai-post-scheduler'); ?></p>';
				aiHtml += '<div class="aips-ai-details">';
				
				if (call.request) {
					aiHtml += '<div class="aips-ai-section">';
					aiHtml += '<h5><?php esc_html_e('Request', 'ai-post-scheduler'); ?></h5>';
					aiHtml += '<div class="aips-json-viewer"><pre>' + escapeHtml(JSON.stringify(call.request, null, 2)) + '</pre></div>';
					aiHtml += '</div>';
				}
				
				if (call.response) {
					aiHtml += '<div class="aips-ai-section">';
					aiHtml += '<h5><?php esc_html_e('Response', 'ai-post-scheduler'); ?></h5>';
					aiHtml += '<div class="aips-json-viewer"><pre>' + escapeHtml(JSON.stringify(call.response, null, 2)) + '</pre></div>';
					aiHtml += '</div>';
				}
				
				aiHtml += '</div></div>';
			});
		} else {
			aiHtml = '<p><?php esc_html_e('No AI calls found.', 'ai-post-scheduler'); ?></p>';
		}
		$('#aips-ai-list').html(aiHtml);
		
		// Show modal
		$('#aips-session-modal').show();
	}
	
	function escapeHtml(text) {
		var map = {
			'&': '&amp;',
			'<': '&lt;',
			'>': '&gt;',
			'"': '&quot;',
			"'": '&#039;'
		};
		return String(text).replace(/[&<>"']/g, function(m) { return map[m]; });
	}
});
</script>
