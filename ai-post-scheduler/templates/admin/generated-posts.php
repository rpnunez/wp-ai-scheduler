<?php
/**
 * Generated Posts Admin Template
 *
 * Displays all posts generated by the AI Post Scheduler plugin.
 *
 * @package AI_Post_Scheduler
 * @since 2.0.0
 */

if (!defined('ABSPATH')) {
	exit;
}
?>

<div class="wrap">
	<h1><?php esc_html_e('Generated Posts', 'ai-post-scheduler'); ?></h1>
	
	<p><?php esc_html_e('View all posts that have been generated by the AI Post Scheduler plugin.', 'ai-post-scheduler'); ?></p>
	
	<!-- Search Form -->
	<form method="get" class="search-form">
		<input type="hidden" name="page" value="aips-generated-posts">
		<p class="search-box">
			<label class="screen-reader-text" for="post-search-input"><?php esc_html_e('Search Posts:', 'ai-post-scheduler'); ?></label>
			<input type="search" id="post-search-input" name="s" value="<?php echo esc_attr($search_query); ?>" placeholder="<?php esc_attr_e('Search posts...', 'ai-post-scheduler'); ?>">
			<input type="submit" id="search-submit" class="button" value="<?php esc_attr_e('Search Posts', 'ai-post-scheduler'); ?>">
		</p>
	</form>
	
	<?php if (!empty($posts_data)): ?>
	<table class="wp-list-table widefat fixed striped">
		<thead>
			<tr>
				<th scope="col"><?php esc_html_e('Title', 'ai-post-scheduler'); ?></th>
				<th scope="col"><?php esc_html_e('Date Scheduled', 'ai-post-scheduler'); ?></th>
				<th scope="col"><?php esc_html_e('Date Published', 'ai-post-scheduler'); ?></th>
				<th scope="col"><?php esc_html_e('Date Generated', 'ai-post-scheduler'); ?></th>
				<th scope="col"><?php esc_html_e('Actions', 'ai-post-scheduler'); ?></th>
			</tr>
		</thead>
		<tbody>
			<?php foreach ($posts_data as $post_data): ?>
			<tr>
				<td>
					<strong>
						<a href="<?php echo esc_url($post_data['edit_link']); ?>">
							<?php echo esc_html($post_data['title']); ?>
						</a>
					</strong>
				</td>
				<td>
					<?php
					if ($post_data['date_scheduled']) {
						echo esc_html(date_i18n(get_option('date_format') . ' ' . get_option('time_format'), strtotime($post_data['date_scheduled'])));
					} else {
						echo 'â€”';
					}
					?>
				</td>
				<td>
					<?php echo esc_html(date_i18n(get_option('date_format') . ' ' . get_option('time_format'), strtotime($post_data['date_published']))); ?>
				</td>
				<td>
					<?php echo esc_html(date_i18n(get_option('date_format') . ' ' . get_option('time_format'), strtotime($post_data['date_generated']))); ?>
				</td>
				<td>
					<?php
					$post_status = get_post_status( $post_data['post_id'] );
					if ( 'publish' === $post_status ) {
						$view_url   = get_permalink( $post_data['post_id'] );
						$view_label = __( 'View', 'ai-post-scheduler' );
						$aria_label = sprintf(
							__( 'View "%s" (opens in a new tab)', 'ai-post-scheduler' ),
							$post_data['title']
						);
					} else {
						$view_url   = get_preview_post_link( $post_data['post_id'] );
						$view_label = __( 'Preview', 'ai-post-scheduler' );
						$aria_label = sprintf(
							__( 'Preview "%s" (opens in a new tab)', 'ai-post-scheduler' ),
							$post_data['title']
						);
					}
					?>
					<a href="<?php echo esc_url( $view_url ); ?>" class="button button-small" target="_blank" rel="noopener noreferrer" aria-label="<?php echo esc_attr( $aria_label ); ?>">
						<?php echo esc_html( $view_label ); ?>
					</a>
					<a href="<?php echo esc_url($post_data['edit_link']); ?>" class="button button-small" aria-label="<?php echo esc_attr(sprintf(__('Edit "%s"', 'ai-post-scheduler'), $post_data['title'])); ?>">
						<?php esc_html_e('Edit', 'ai-post-scheduler'); ?>
					</a>
					<button class="button button-small aips-view-session" data-history-id="<?php echo esc_attr($post_data['history_id']); ?>">
						<?php esc_html_e('View Session', 'ai-post-scheduler'); ?>
					</button>
				</td>
			</tr>
			<?php endforeach; ?>
		</tbody>
		<tfoot>
			<tr>
				<th scope="col"><?php esc_html_e('Title', 'ai-post-scheduler'); ?></th>
				<th scope="col"><?php esc_html_e('Date Scheduled', 'ai-post-scheduler'); ?></th>
				<th scope="col"><?php esc_html_e('Date Published', 'ai-post-scheduler'); ?></th>
				<th scope="col"><?php esc_html_e('Date Generated', 'ai-post-scheduler'); ?></th>
				<th scope="col"><?php esc_html_e('Actions', 'ai-post-scheduler'); ?></th>
			</tr>
		</tfoot>
	</table>
	
	<!-- Pagination -->
	<?php if ($history['pages'] > 1): ?>
		<div class="tablenav">
			<div class="tablenav-pages">
				<?php
				$page_links = paginate_links(array(
					'base' => add_query_arg('paged', '%#%'),
					'format' => '',
					'prev_text' => '&laquo;',
					'next_text' => '&raquo;',
					'total' => $history['pages'],
					'current' => $current_page,
				));
				if ($page_links) {
					echo '<span class="displaying-num">' . sprintf(
						/* translators: %s: total number of items */
						_n('%s item', '%s items', $history['total'], 'ai-post-scheduler'),
						number_format_i18n($history['total'])
					) . '</span>';
					echo wp_kses_post( $page_links );
				}
				?>
			</div>
		</div>
	<?php endif; ?>

	<?php else: ?>
	<div class="aips-empty-state">
		<span class="dashicons dashicons-admin-post" aria-hidden="true"></span>
		<h3><?php esc_html_e('No Generated Posts Found', 'ai-post-scheduler'); ?></h3>
		<p><?php esc_html_e('Posts generated by the AI will appear here.', 'ai-post-scheduler'); ?></p>
	</div>
	<?php endif; ?>
</div>

<?php
// Include the View Session modal partial
include AIPS_PLUGIN_DIR . 'templates/partials/view-session-modal.php';
?>
