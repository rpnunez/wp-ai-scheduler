<?php
/**
 * Generated Posts Admin Template
 *
 * Displays all posts generated by the AI Post Scheduler plugin.
 *
 * @package AI_Post_Scheduler
 * @since 2.0.0
 */

if (!defined('ABSPATH')) {
	exit;
}
?>

<div class="wrap">
	<h1><?php esc_html_e('Generated Posts', 'ai-post-scheduler'); ?></h1>
	
	<p><?php esc_html_e('View all posts that have been generated by the AI Post Scheduler plugin.', 'ai-post-scheduler'); ?></p>
	
	<!-- Search Form -->
	<form method="get" class="search-form">
		<input type="hidden" name="page" value="aips-generated-posts">
		<p class="search-box">
			<label class="screen-reader-text" for="post-search-input"><?php esc_html_e('Search Posts:', 'ai-post-scheduler'); ?></label>
			<input type="search" id="post-search-input" name="s" value="<?php echo esc_attr($search_query); ?>" placeholder="<?php esc_attr_e('Search posts...', 'ai-post-scheduler'); ?>">
			<input type="submit" id="search-submit" class="button" value="<?php esc_attr_e('Search Posts', 'ai-post-scheduler'); ?>">
            <?php if ( ! empty( $search_query ) ) : ?>
                <a href="<?php echo esc_url( remove_query_arg( 's' ) ); ?>" class="button button-link-delete"><?php esc_html_e( 'Clear', 'ai-post-scheduler' ); ?></a>
            <?php endif; ?>
		</p>
	</form>
	
	<?php if (!empty($posts_data)): ?>
	<table class="wp-list-table widefat fixed striped">
		<thead>
			<tr>
				<th scope="col"><?php esc_html_e('Title', 'ai-post-scheduler'); ?></th>
				<th scope="col"><?php esc_html_e('Date Scheduled', 'ai-post-scheduler'); ?></th>
				<th scope="col"><?php esc_html_e('Date Published', 'ai-post-scheduler'); ?></th>
				<th scope="col"><?php esc_html_e('Date Generated', 'ai-post-scheduler'); ?></th>
				<th scope="col"><?php esc_html_e('Actions', 'ai-post-scheduler'); ?></th>
			</tr>
		</thead>
		<tbody>
			<?php foreach ($posts_data as $post_data): ?>
			<tr>
				<td>
					<strong>
						<a href="<?php echo esc_url($post_data['edit_link']); ?>">
							<?php echo esc_html($post_data['title']); ?>
						</a>
					</strong>
				</td>
				<td>
					<?php
					if ($post_data['date_scheduled']) {
						echo esc_html(date_i18n(get_option('date_format') . ' ' . get_option('time_format'), strtotime($post_data['date_scheduled'])));
					} else {
						echo 'â€”';
					}
					?>
				</td>
				<td>
					<?php echo esc_html(date_i18n(get_option('date_format') . ' ' . get_option('time_format'), strtotime($post_data['date_published']))); ?>
				</td>
				<td>
					<?php echo esc_html(date_i18n(get_option('date_format') . ' ' . get_option('time_format'), strtotime($post_data['date_generated']))); ?>
				</td>
				<td>
					<?php
					$post_status = get_post_status( $post_data['post_id'] );
					if ( 'publish' === $post_status ) {
						$view_url   = get_permalink( $post_data['post_id'] );
						$view_label = __( 'View', 'ai-post-scheduler' );
						$aria_label = sprintf(
							__( 'View "%s" (opens in a new tab)', 'ai-post-scheduler' ),
							$post_data['title']
						);
					} else {
						$view_url   = get_preview_post_link( $post_data['post_id'] );
						$view_label = __( 'Preview', 'ai-post-scheduler' );
						$aria_label = sprintf(
							__( 'Preview "%s" (opens in a new tab)', 'ai-post-scheduler' ),
							$post_data['title']
						);
					}
					?>
					<a href="<?php echo esc_url( $view_url ); ?>" class="button button-small" target="_blank" rel="noopener noreferrer" aria-label="<?php echo esc_attr( $aria_label ); ?>">
						<?php echo esc_html( $view_label ); ?>
					</a>
					<a href="<?php echo esc_url($post_data['edit_link']); ?>" class="button button-small" aria-label="<?php echo esc_attr(sprintf(__('Edit "%s"', 'ai-post-scheduler'), $post_data['title'])); ?>">
						<?php esc_html_e('Edit', 'ai-post-scheduler'); ?>
					</a>
					<button class="button button-small aips-view-session" data-history-id="<?php echo esc_attr($post_data['history_id']); ?>">
						<?php esc_html_e('View Session', 'ai-post-scheduler'); ?>
					</button>
				</td>
			</tr>
			<?php endforeach; ?>
		</tbody>
		<tfoot>
			<tr>
				<th scope="col"><?php esc_html_e('Title', 'ai-post-scheduler'); ?></th>
				<th scope="col"><?php esc_html_e('Date Scheduled', 'ai-post-scheduler'); ?></th>
				<th scope="col"><?php esc_html_e('Date Published', 'ai-post-scheduler'); ?></th>
				<th scope="col"><?php esc_html_e('Date Generated', 'ai-post-scheduler'); ?></th>
				<th scope="col"><?php esc_html_e('Actions', 'ai-post-scheduler'); ?></th>
			</tr>
		</tfoot>
	</table>
	
	<!-- Pagination -->
	<?php if ($history['pages'] > 1): ?>
		<div class="tablenav">
			<div class="tablenav-pages">
				<?php
				$page_links = paginate_links(array(
					'base' => add_query_arg('paged', '%#%'),
					'format' => '',
					'prev_text' => '&laquo;',
					'next_text' => '&raquo;',
					'total' => $history['pages'],
					'current' => $current_page,
				));
				if ($page_links) {
					echo '<span class="displaying-num">' . sprintf(
						/* translators: %s: total number of items */
						_n('%s item', '%s items', $history['total'], 'ai-post-scheduler'),
						number_format_i18n($history['total'])
					) . '</span>';
					echo wp_kses_post( $page_links );
				}
				?>
			</div>
		</div>
	<?php endif; ?>

	<?php else: ?>
	<div class="aips-empty-state">
		<span class="dashicons dashicons-admin-post" aria-hidden="true"></span>
		<h3><?php esc_html_e('No Generated Posts Found', 'ai-post-scheduler'); ?></h3>
		<p><?php esc_html_e('Posts generated by the AI will appear here.', 'ai-post-scheduler'); ?></p>
	</div>
	<?php endif; ?>
</div>

<!-- Session View Modal -->
<div id="aips-session-modal" class="aips-modal" style="display: none;">
	<div class="aips-modal-overlay"></div>
	<div class="aips-modal-content">
		<div class="aips-modal-header">
			<h2><?php esc_html_e('View Session', 'ai-post-scheduler'); ?></h2>
			<div class="aips-modal-header-actions">
				<button class="button button-primary aips-copy-session-json">
					<?php esc_html_e('Copy Session JSON', 'ai-post-scheduler'); ?>
				</button>
				<button class="button aips-download-session-json">
					<?php esc_html_e('Download Session JSON', 'ai-post-scheduler'); ?>
				</button>
				<button class="aips-modal-close" aria-label="<?php esc_attr_e('Close', 'ai-post-scheduler'); ?>">
					<span class="dashicons dashicons-no"></span>
				</button>
			</div>
		</div>
		<div class="aips-modal-body">
			<div class="aips-session-info">
				<p><strong><?php esc_html_e('Post:', 'ai-post-scheduler'); ?></strong> <span id="aips-session-title"></span></p>
				<p><strong><?php esc_html_e('Generated:', 'ai-post-scheduler'); ?></strong> <span id="aips-session-created"></span></p>
				<p><strong><?php esc_html_e('Completed:', 'ai-post-scheduler'); ?></strong> <span id="aips-session-completed"></span></p>
			</div>
			
			<div class="aips-tabs">
				<ul class="aips-tab-nav">
					<li><a href="#aips-tab-logs" class="active"><?php esc_html_e('Logs', 'ai-post-scheduler'); ?></a></li>
					<li><a href="#aips-tab-ai"><?php esc_html_e('AI', 'ai-post-scheduler'); ?></a></li>
				</ul>
				
				<div id="aips-tab-logs" class="aips-tab-content active">
					<div id="aips-logs-list"></div>
				</div>
				
				<div id="aips-tab-ai" class="aips-tab-content" style="display: none;">
					<div id="aips-ai-list"></div>
				</div>
			</div>
		</div>
	</div>
</div>

<script>
// Make history type constants available to the JS file
window.AIPS_History_Type = {
	LOG: <?php echo AIPS_History_Type::LOG; ?>,
	ERROR: <?php echo AIPS_History_Type::ERROR; ?>,
	WARNING: <?php echo AIPS_History_Type::WARNING; ?>,
	INFO: <?php echo AIPS_History_Type::INFO; ?>,
	AI_REQUEST: <?php echo AIPS_History_Type::AI_REQUEST; ?>,
	AI_RESPONSE: <?php echo AIPS_History_Type::AI_RESPONSE; ?>,
	DEBUG: <?php echo AIPS_History_Type::DEBUG; ?>,
	ACTIVITY: <?php echo AIPS_History_Type::ACTIVITY; ?>,
	SESSION_METADATA: <?php echo AIPS_History_Type::SESSION_METADATA; ?>
};

// Make AJAX nonce available to the JS file
window.aipsAjaxNonce = '<?php echo wp_create_nonce('aips_ajax_nonce'); ?>';
</script>
